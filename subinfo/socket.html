
<!doctype html>
<html>
<head>
    <title>Chat service</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js"></script>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
    <style>
        #debug_list {
            width: 100%;
            height: 750px;
            overflow-y: auto;
        }

        #chat_room_messages {
            width: 100%;
            height: 410px;
            overflow-y: auto;
        }

        ::-webkit-scrollbar {
            -webkit-appearance: none;
            width: 7px;
        }

        ::-webkit-scrollbar-thumb {
            border-radius: 4px;
            background-color: rgba(0, 0, 0, .5);
            box-shadow: 0 0 1px rgba(255, 255, 255, .5);
        }

        .loader {
            border: 16px solid #f3f3f3; /* Light grey */
            border-top: 16px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 120px;
            height: 120px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>

<div class="container-fluid" style="margin-top: 30px;">
    <div class="row">
        <div class="col-md-12" id="server_status"></div>
    </div>
    <div class="row">
        <div class="col-md-2">
            <div class="row">
                <div class="col-md-12">
                    <div class="panel panel-info">
                        <div class="panel-heading">Connect To Socket</div>
                        <div class="panel-body">
                            <div class="form-group">
                                <label for="server_url">Server Endpoint</label>
                                <input class="form-control" type="text" id="server_url" value="http://localhost:3000"/>
                            </div>
                            <div class="form-group">
                                <label for="token">Authentication Token</label>
                                <input class="form-control" type="text" id="token" value="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MTAwMDAsInVzZXJuYW1lIjoic2l2ZXJ0MTUiLCJlbWFpbCI6InNpdmVydF9sYXJzZW4xNUB5YWhvby5jb20iLCJmaXJzdF9uYW1lIjoiU2l2ZXJ0IiwibGFzdF9uYW1lIjoiTGFyc2VuIiwic3RhdHVzIjoxLCJpYXQiOjE1OTM1NDA3NjIsImV4cCI6MTU5MzU0MjU2Mn0.OItDNcFdFEWLRsG4Di65fG1fc_HGFnXsXOyZmwL1JHE"/>
                            </div>
                            <div class="form-group">
                                <label for="user_photo">Device Token</label>
                                <input class="form-control" type="text" id="device_token" value="eYQGytpD2XA:APA91bGGc-MpKFkr7GiiRyQb_Q9er6iPU8ylHo2cRgKG0xZFpH3g1EZQyyfu4Vd2U6ZFEN0mFVUEQutvP_GnvMOV1DYyjbO-vcqtbEc9pwb3DLxc5kzXMm-L8Ure7Mbo32wJHY88uFQs"/>
                            </div>
                            <div class="form-group">
                                <label for="user_photo">Device Platform</label>
                                <input class="form-control" type="text" id="device_platform" value="web"/>
                            </div>
                            <div class="btn-group-vertical" style="width: 100%;">
                                <button class="btn btn-default block" id="connect_to_socket">Connect</button>
                                <button class="btn btn-default block" id="disconnect_from_socket" style="display:none;">Disconnect</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="row">
                <div class="col-md-12">
                    <div class="panel panel-info">
                        <div class="panel-heading">Connect To Room</div>
                        <div class="panel-body">
                            <label for="channel_id">Channel Id</label>
                            <input class="form-control" type="text" id="channel_id" placeholder="room id" value="10004"/>
                            <div>
                                <label class="radio-inline">
                                    <input type="radio" name="channel_type" id="type_private" value="0" checked> Private
                                </label>
                                <label class="radio-inline">
                                    <input type="radio" name="channel_type" id="type_group" value="1"> Group
                                </label>
                            </div>
                            <div class="btn-group-vertical" style="width: 100%;margin-top: 22px;">
                                <button class="btn btn-danger block" id="create_room">Create New Room</button>
                                <button class="btn btn-default btn-block" id="join_room">Join Room</button>
                                <button class="btn btn-default btn-block" id="leave_room">Leave Room</button>
                                <button class="btn btn-default btn-block" id="close_room">Close & Sync Room</button>
                                <button class="btn btn-default btn-block" id="open_room">Open Room</button>
                                <button class="btn btn-default btn-block" id="list_room">List User Rooms</button>
                                <button class="btn btn-default btn-block" id="history_room">Fetch Chat History</button>
                                <button class="btn btn-default btn-block" id="chat_room_users">Fetch Chat Room Users</button>
                                <button class="btn btn-default btn-block" data-toggle="modal" data-target="#delete_room_model">Delete Message</button>
                                <button class="btn btn-default btn-block" data-toggle="modal" data-target="#read_message_model">Read Message Status</button>
                                <button class="btn btn-default btn-block" data-toggle="modal" data-target="#received_message_model">Received Message Status</button>
                                <button class="btn btn-default btn-block" data-toggle="modal" data-target="#typing_message_model">Typing Message Status</button>
                                <button class="btn btn-default btn-block" data-toggle="modal" data-target="#check_online_model">Online Status</button>
                                <button class="btn btn-default btn-block" data-toggle="modal" data-target="#call_offer_model">Call Offer</button>
                                <button class="btn btn-default btn-block" data-toggle="modal" data-target="#call_answer_model">Call Answer</button>
                                <button class="btn btn-default btn-block" id="call_close">Call Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-8">
            <div class="row">
                <div class="col-md-12">
                    <div class="panel panel-default">
                        <div class="panel-heading">Chat Room Messages</div>
                        <div class="panel-body">
                            <ul id="chat_room_messages">
                                <li>
                                    <ul>
                                        <li>you should input correct channel id before send message</li>
                                        <li>if you're going to send private message, input friend user_id on the 'Channel Id' field</li>
                                        <li>if you're going to send private message, input room_id on the 'Channel Id' field</li>
                                    </ul>
                                </li>
                            </ul>
                        </div>
                        <div class="panel-footer">
                            <div class="row">
                                <div class="col-md-9">
                                    <input type="text" class="form-control" id="message_content" placeholder="type your message...">
                                </div>
                                <div class="col-md-3">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <button id="send_message" class="btn btn-danger">Send Now</button>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="dropdown">
                                                <button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">Attachment
                                                    <span class="caret"></span></button>
                                                <ul class="dropdown-menu">
                                                    <li><a class="send_file_button" data-toggle="modal" data-target="#send_file_model" href="#" data-type="1">Image</a></li>
                                                    <li><a class="send_file_button" data-toggle="modal" data-target="#send_file_model" href="#" data-type="2">Video</a></li>
                                                    <li><a class="send_file_button" data-toggle="modal" data-target="#send_file_model" href="#" data-type="3">Voice</a></li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <div class="panel panel-danger">
                <div class="panel-heading">Debug Window</div>
                <div class="panel-body">
                    <ul id="debug_list"></ul>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="delete_room_model" class="modal fade" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Delete Message From Chat Room</h4>
            </div>
            <div class="modal-body">
                <ul>
                    <li>you should be join to room</li>
                    <li>room should be open</li>
                    <li>user should be owner of message</li>
                </ul>
                <div class="form-group">
                    <label for="message_id">Message Id</label>
                    <input class="form-control" type="text" id="message_id"/>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" data-dismiss="modal" id="delete_message">Delete</button>
            </div>
        </div>
    </div>
</div>

<div id="read_message_model" class="modal fade" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Send Read Message Status</h4>
            </div>
            <div class="modal-body">
                <ul>
                    <li>you should be join to room</li>
                    <li>room should be open</li>
                    <li>user should be owner of message</li>
                </ul>
                <div class="form-group">
                    <label for="read_status_message_id">Message Id</label>
                    <input class="form-control" type="text" id="read_status_message_id"/>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" data-dismiss="modal" id="read_status_message_button">Update Status</button>
            </div>
        </div>
    </div>
</div>

<div id="received_message_model" class="modal fade" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Send Received Message Status</h4>
            </div>
            <div class="modal-body">
                <ul>
                    <li>you should be join to room</li>
                    <li>room should be open</li>
                    <li>user should be owner of message</li>
                </ul>
                <div class="form-group">
                    <label for="received_status_message_id">Message Id</label>
                    <input class="form-control" type="text" id="received_status_message_id"/>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" data-dismiss="modal" id="received_status_message_button">Update Status</button>
            </div>
        </div>
    </div>
</div>

<div id="typing_message_model" class="modal fade" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Send Typing Message Status</h4>
            </div>
            <div class="modal-body">
                <ul>
                    <li>you should be join to room</li>
                    <li>room should be open</li>
                    <li>typing status is true or false</li>
                </ul>
                <div class="form-group">
                    <label for="typing_status_message">Set Typing Status</label>
                    <input class="form-control" type="text" id="typing_status_message" value="true"/>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" data-dismiss="modal" id="typing_status_message_button">Send Status</button>
            </div>
        </div>
    </div>
</div>

<div id="check_online_model" class="modal fade" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Check User Status</h4>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="online_status_user_type">User Type</label>
                    <input class="form-control" type="text" id="online_status_user_type" value="shopper"/>
                    <label for="online_status_user_id">User Id</label>
                    <input class="form-control" type="text" id="online_status_user_id" value="103"/>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" data-dismiss="modal" id="online_status_button">Check Status</button>
            </div>
        </div>
    </div>
</div>

<div id="call_offer_model" class="modal fade" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Call Offer</h4>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="online_status_user_type">Offer data</label>
                    <input class="form-control" type="text" id="call_offer" value="any dummy data"/>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" data-dismiss="modal" id="call_offer_button">Offer</button>
            </div>
        </div>
    </div>
</div>

<div id="call_answer_model" class="modal fade" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Call Answer</h4>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="online_status_user_type">Answer data</label>
                    <input class="form-control" type="text" id="call_answer" value="any dummy data"/>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" data-dismiss="modal" id="call_answer_button">Offer</button>
            </div>
        </div>
    </div>
</div>

<div id="send_file_model" class="modal fade" role="dialog" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog">
        <div class="modal-content" id="upload_content">
            <div class="modal-header">
                <h4 class="modal-title">Upload File</h4>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <ul>
                        <li>you should be connected to socket server</li>
                        <li>you should be join to room</li>
                        <li>room should be open</li>
                    </ul>
                    <form>
                        <label for="message_id">Select your file</label>
                        <input class="form-control" type="file" id="selected_file"/>
                    </form>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal" id="send_file_cancel">Cancel</button>
                <button type="button" class="btn btn-danger" id="send_file_button">Send Now</button>
            </div>
        </div>
        <div class="modal-content text-center" id="upload_loading" style="display: none;">
            <center>
                <h3>Sending your file</h3>
                <div class="loader"></div>
                <h3>Please Wait file start uploading...</h3>
            </center>
        </div>
    </div>
</div>

<body>

<script>
    var SOCKET_KEY_USER_LOGIN                      = 'socket:key:user:login';
    var SOCKET_KEY_CHAT_MESSAGE                    = 'socket:key:chat:message';
    var SOCKET_KEY_CHAT_HISTORY                    = 'socket:key:chat:history';
    var SOCKET_KEY_CALL_OFFER                      = 'socket:key:call:offer';
    var SOCKET_KEY_CALL_ANSWER                     = 'socket:key:call:answer';
    var SOCKET_KEY_CALL_CLOSE                      = 'socket:key:call:close';

    var SOCKET_EVENT_CHAT_MESSAGE                  = 'socket:event:chat:message';
    var SOCKET_EVENT_CHAT_READ                     = 'socket:event:chat:read';
    var SOCKET_EVENT_CHAT_TYPING                   = 'socket:event:chat:typing';
    var SOCKET_EVENT_CALL_OFFER                    = 'socket:event:call:offer';
    var SOCKET_EVENT_CALL_ANSWER                   = 'socket:event:call:answer';
    var SOCKET_EVENT_CALL_CLOSE                    = 'socket:event:call:close';

    var ChatChannelType = {
        Private: 0,
        Group: 1,
    }

    var ChatContentType = {
        Text: 0,
        Image: 1,
        Video: 2,
        Audio: 3,
    }

    var channel_type = ChatChannelType.Private;
    var content_type = ChatContentType.Text;
    var socket = null;
    var disconnectedByError = false;

    $("#server_url").val(window.location.origin)

    $('#create_room').prop("disabled", true);
    $('#join_room').prop("disabled", true);
    $('#leave_room').prop("disabled", true);
    $('#close_room').prop("disabled", true);
    $('#open_room').prop("disabled", true);

    $("#connect_to_socket").click(function () {

        socket = io($("#server_url").val(),{
            transports: ['websocket'],
        });
        
        socket.on('connect', () => {
            socket.emit(SOCKET_KEY_USER_LOGIN,
                $("#token").val(),
                (error, res) => {
                    if (error) {
                        console.error(error);
                        $("#server_status").html(`
                            <div class="alert alert-danger">
                            <strong>Error</strong> ${error}
                            </div>
                        `);
                        disconnectedByError = true;
                        socket.close();
                    } else {
                        $("#server_status").html(`
                            <div class="alert alert-success">
                            <strong>Connected</strong> you are connected to socket server.
                            </div>
                        `);
                        $('#connect_to_socket').hide();
                        $('#disconnect_from_socket').show();
                        $("#debug_list").append(`<li>connect to server:<pre>${JSON.stringify({
                            socketId: res,
                        }, null, 4)}</pre></li>`);
                        $('#debug_list').animate({scrollTop: $('#debug_list').prop("scrollHeight")}, 123);
                    }
            });
        });

        socket.on('disconnect',() => {
            if (!disconnectedByError) {
                $("#server_status").html(`
                    <div class="alert alert-danger">
                    <strong>Disconnected</strong> you are disconnected from socket server.
                    </div>
                `);
                $('#connect_to_socket').show();
                $('#disconnect_from_socket').hide();
                $("#debug_list").append(`<li>disconnected from server:<pre>${JSON.stringify({
                    token: $("#token").val(),
                }, null, 4)}</pre></li>`);
                $('#debug_list').animate({scrollTop: $('#debug_list').prop("scrollHeight")}, 123);
            }
            disconnectedByError = false;
        });

        //on get new messages from socket
        socket.on(SOCKET_EVENT_CHAT_MESSAGE,function (message) {
            $("#chat_room_messages").append(`<li>receive_message_chat_room: <pre>${JSON.stringify(message, null, 4)}</pre></li>`);
            $('#chat_room_messages').animate({scrollTop: $('#chat_room_messages').prop("scrollHeight")}, 123);
            $("#debug_list").append(`<li>receive_message_chat_room: <pre>${JSON.stringify(message, null, 4)}</pre></li>`);
            $('#debug_list').animate({scrollTop: $('#debug_list').prop("scrollHeight")}, 123);
        });

        //on read status from socket
        socket.on(SOCKET_EVENT_CHAT_READ,function (response) {
            $("#chat_room_messages").append(`<li>read_message_chat_room: <pre>${JSON.stringify(JSON.parse(response), null, 4)}</pre></li>`);
            $('#chat_room_messages').animate({scrollTop: $('#chat_room_messages').prop("scrollHeight")}, 123);
            $("#debug_list").append(`<li>read_message_chat_room: <pre>${JSON.stringify(JSON.parse(response), null, 4)}</pre></li>`);
            $('#debug_list').animate({scrollTop: $('#debug_list').prop("scrollHeight")}, 123);
        });

        //on received status from socket
        socket.on('chat:room:listen:received:status',function (response) {
            $("#chat_room_messages").append(`<li>received_message_chat_room: <pre>${JSON.stringify(JSON.parse(response), null, 4)}</pre></li>`);
            $('#chat_room_messages').animate({scrollTop: $('#chat_room_messages').prop("scrollHeight")}, 123);
            $("#debug_list").append(`<li>received_message_chat_room: <pre>${JSON.stringify(JSON.parse(response), null, 4)}</pre></li>`);
            $('#debug_list').animate({scrollTop: $('#debug_list').prop("scrollHeight")}, 123);
        });

        //on typing status from socket
        socket.on(SOCKET_EVENT_CHAT_TYPING,function (response) {
            $("#chat_room_messages").append(`<li>typing_message_chat_room: <pre>${JSON.stringify(JSON.parse(response), null, 4)}</pre></li>`);
            $('#chat_room_messages').animate({scrollTop: $('#chat_room_messages').prop("scrollHeight")}, 123);
            $("#debug_list").append(`<li>typing_message_chat_room: <pre>${JSON.stringify(JSON.parse(response), null, 4)}</pre></li>`);
            $('#debug_list').animate({scrollTop: $('#debug_list').prop("scrollHeight")}, 123);
        });

        //get call offer from socket
        socket.on(SOCKET_EVENT_CALL_OFFER,function (response) {
            $("#chat_room_messages").append(`<li>call_offer: <pre>${JSON.stringify(response, null, 4)}</pre></li>`);
            $('#chat_room_messages').animate({scrollTop: $('#chat_room_messages').prop("scrollHeight")}, 123);
            $("#debug_list").append(`<li>call_offer: <pre>${JSON.stringify(response, null, 4)}</pre></li>`);
            $('#debug_list').animate({scrollTop: $('#debug_list').prop("scrollHeight")}, 123);
        });

        //get call answer from socket
        socket.on(SOCKET_EVENT_CALL_ANSWER,function (response) {
            $("#chat_room_messages").append(`<li>call_answer: <pre>${JSON.stringify(response, null, 4)}</pre></li>`);
            $('#chat_room_messages').animate({scrollTop: $('#chat_room_messages').prop("scrollHeight")}, 123);
            $("#debug_list").append(`<li>call_answer: <pre>${JSON.stringify(response, null, 4)}</pre></li>`);
            $('#debug_list').animate({scrollTop: $('#debug_list').prop("scrollHeight")}, 123);
        });

        //get call close from socket
        socket.on(SOCKET_EVENT_CALL_CLOSE,function (response) {
            $("#chat_room_messages").append(`<li>call_close: <pre>${JSON.stringify(response, null, 4)}</pre></li>`);
            $('#chat_room_messages').animate({scrollTop: $('#chat_room_messages').prop("scrollHeight")}, 123);
            $("#debug_list").append(`<li>call_close: <pre>${JSON.stringify(response, null, 4)}</pre></li>`);
            $('#debug_list').animate({scrollTop: $('#debug_list').prop("scrollHeight")}, 123);
        });

    });

    $('input[type=radio][name=channel_type]').change(function() {
        channel_type = parseInt(this.value);

        $('#create_room').prop("disabled", channel_type == ChatChannelType.Private);
        $('#join_room').prop("disabled", channel_type == ChatChannelType.Private);
        $('#leave_room').prop("disabled", channel_type == ChatChannelType.Private);
        $('#close_room').prop("disabled", channel_type == ChatChannelType.Private);
        $('#open_room').prop("disabled", channel_type == ChatChannelType.Private);
    });

    $('#create_room').click(function () {
        socket.emit('chat:room:create',{channel_id:$('#channel_id').val()},function (response) {
            $("#debug_list").append(`<li>create_chat_room: <pre>${JSON.stringify(JSON.parse(response), null, 4)}</pre></li>`);
            $('#debug_list').animate({scrollTop: $('#debug_list').prop("scrollHeight")}, 123);
        });
    });

    $('#join_room').click(function () {
        const orderId = $('#channel_id').val();
        socket.emit('chat:room:join',{
            channel_id:orderId
        },function (response) {
            sendSystemMessage(orderId,`${$('#user_name').val()} join the room`);
            $("#debug_list").append(`<li>join_chat_room: <pre>${JSON.stringify(JSON.parse(response), null, 4)}</pre></li>`);
            $('#debug_list').animate({scrollTop: $('#debug_list').prop("scrollHeight")}, 123);
        });
    });

    $('#leave_room').click(function () {
        sendSystemMessage($('#channel_id').val(),`${$('#user_name').val()} leave the room`);
        socket.emit('chat:room:leave',{channel_id:$('#channel_id').val()},function (response) {
            $("#debug_list").append(`<li>leave_chat_room: <pre>${JSON.stringify(JSON.parse(response), null, 4)}</pre></li>`);
            $('#debug_list').animate({scrollTop: $('#debug_list').prop("scrollHeight")}, 123);
        });
    });

    $('#close_room').click(function () {
        socket.emit('chat:room:close',{channel_id:$('#channel_id').val()},function (response) {
            $("#debug_list").append(`<li>close_chat_room: <pre>${JSON.stringify(JSON.parse(response), null, 4)}</pre></li>`);
            $('#debug_list').animate({scrollTop: $('#debug_list').prop("scrollHeight")}, 123);
        });
    });

    $('#open_room').click(function () {
        socket.emit('chat:room:open',{channel_id:$('#channel_id').val()},function (response) {
            $("#debug_list").append(`<li>open_chat_room: <pre>${JSON.stringify(JSON.parse(response), null, 4)}</pre></li>`);
            $('#debug_list').animate({scrollTop: $('#debug_list').prop("scrollHeight")}, 123);
        });
    });

    $('#list_room').click(function () {
        socket.emit('chat:room:list',null,function (response) {
            $("#debug_list").append(`<li>list_chat_room: <pre>${JSON.stringify(JSON.parse(response), null, 4)}</pre></li>`);
            $('#debug_list').animate({scrollTop: $('#debug_list').prop("scrollHeight")}, 123);
        });
    });

    $('#chat_room_users').click(function () {
        socket.emit('chat:room:get:users',{channel:$('#channel_id').val()},function (response) {
            $("#debug_list").append(`<li>chat_room_users: <pre>${JSON.stringify(JSON.parse(response), null, 4)}</pre></li>`);
            $('#debug_list').animate({scrollTop: $('#debug_list').prop("scrollHeight")}, 123);
        });
    });

    $('#history_room').click(function () {
        socket.emit(SOCKET_KEY_CHAT_HISTORY,{channel:$('#channel_id').val(), type:channel_type},function (error, messages) {
            if (error) {
                $("#debug_list").append(`<li>chat_room_history error: <pre>${error}</pre></li>`);
                $('#debug_list').animate({scrollTop: $('#debug_list').prop("scrollHeight")}, 123);
            } else {
                $("#debug_list").append(`<li>chat_room_history: <pre>${JSON.stringify(messages, null, 4)}</pre></li>`);
                $('#debug_list').animate({scrollTop: $('#debug_list').prop("scrollHeight")}, 123);

                for (var i in messages) {
                    $("#chat_room_messages").append(`<li>chat_room_history: <pre>${JSON.stringify(messages[i], null, 4)}</pre></li>`);
                    $('#chat_room_messages').animate({scrollTop: $('#chat_room_messages').prop("scrollHeight")}, 123);
                }
            }
        });
    });

    $('#delete_message').click(function () {
        socket.emit('chat:room:delete',{channel_id:$('#channel_id').val(),message_id:$('#message_id').val()},function (response) {
            $("#debug_list").append(`<li>delete_chat_room: <pre>${JSON.stringify(JSON.parse(response), null, 4)}</pre></li>`);
            $('#debug_list').animate({scrollTop: $('#debug_list').prop("scrollHeight")}, 123);
        });
    });

    $('#send_message').click(function () {
        const message_content = $('#message_content').val();
        if (!message_content) {
            return alert('message content is empty')
        }
        socket.emit(SOCKET_KEY_CHAT_MESSAGE,{
            channel: $('#channel_id').val(),
            content: {
                text: message_content,
                type: content_type,
            },
            type: channel_type,
        },function (error, message) {
            content_type = ChatContentType.Text;
            if (error) {
                console.error(error);
                $("#debug_list").append(`<li>send_message_chat_room error: <pre>${error}</pre></li>`);
                $('#debug_list').animate({scrollTop: $('#debug_list').prop("scrollHeight")}, 123);
            } else {
                $('#message_content').val('');
                $("#chat_room_messages").append(`<li>send_message_chat_room: <pre>${JSON.stringify(message, null, 4)}</pre></li>`);
                $('#chat_room_messages').animate({scrollTop: $('#debug_list').prop("scrollHeight")}, 123);
                $("#debug_list").append(`<li>send_message_chat_room: <pre>${JSON.stringify(message, null, 4)}</pre></li>`);
                $('#debug_list').animate({scrollTop: $('#debug_list').prop("scrollHeight")}, 123);
            }
        });
    });

    $("#send_file_cancel").click(function () {
        content_type = ChatContentType.Text;
    });

    $('#received_status_message_button').click(function () {
        socket.emit('chat:room:send:read:status',{channel_id:$('#channel_id').val(),message_id:$('#received_status_message_id').val()},function (response) {
            $("#debug_list").append(`<li>received_message_status_chat_room: <pre>${JSON.stringify(JSON.parse(response), null, 4)}</pre></li>`);
            $('#debug_list').animate({scrollTop: $('#debug_list').prop("scrollHeight")}, 123);
        });
    });

    $('#read_status_message_button').click(function () {
        socket.emit('chat:room:send:received:status',{channel_id:$('#channel_id').val(),message_id:$('#read_status_message_id').val()},function (response) {
            $("#debug_list").append(`<li>read_message_status_chat_room: <pre>${JSON.stringify(JSON.parse(response), null, 4)}</pre></li>`);
            $('#debug_list').animate({scrollTop: $('#debug_list').prop("scrollHeight")}, 123);
        });
    });

    $('#typing_status_message_button').click(function () {
        socket.emit('chat:room:send:typing:status',{channel_id:$('#channel_id').val(),is_typing:$('#typing_status_message').val()},function (response) {
            $("#debug_list").append(`<li>typing_message_status_chat_room: <pre>${JSON.stringify(JSON.parse(response), null, 4)}</pre></li>`);
            $('#debug_list').animate({scrollTop: $('#debug_list').prop("scrollHeight")}, 123);
        });
    });

    $('#online_status_button').click(function () {
        if (!$('#online_status_user_type').val()) {
            return alert('user type is empty')
        }
        if (!$('#online_status_user_id').val()) {
            return alert('user id is empty')
        }
        socket.emit('chat:user:check:online:status',{user_type:$('#online_status_user_type').val(),user_id:$('#online_status_user_id').val()},function (response) {
            $("#debug_list").append(`<li>check_user_online_status_chat_room: <pre>${JSON.stringify(JSON.parse(response), null, 4)}</pre></li>`);
            $('#debug_list').animate({scrollTop: $('#debug_list').prop("scrollHeight")}, 123);
        });
    });
    
    $('#call_offer_button').click(function () {
        if (!$('#call_offer').val()) {
            return alert('offer data is empty')
        }
        socket.emit(SOCKET_KEY_CALL_OFFER,{
            channel: $('#channel_id').val(),
            offer: $('#call_offer').val(),
            type: channel_type,
        },function (error, message) {
            if (error) {
                console.error(error);
                $("#debug_list").append(`<li>send_message_chat_room error: <pre>${error}</pre></li>`);
                $('#debug_list').animate({scrollTop: $('#debug_list').prop("scrollHeight")}, 123);
            } else {
                $("#debug_list").append(`<li>call_offer: <pre>${JSON.stringify(message, null, 4)}</pre></li>`);
                $('#debug_list').animate({scrollTop: $('#debug_list').prop("scrollHeight")}, 123);
            }
        });
    });

    $('#call_answer_button').click(function () {
        if (!$('#call_answer').val()) {
            return alert('answer data is empty')
        }
        socket.emit(SOCKET_KEY_CALL_ANSWER,{
            channel: $('#channel_id').val(),
            answer: $('#call_answer').val(),
            type: channel_type,
        },function (error, message) {
            if (error) {
                console.error(error);
                $("#debug_list").append(`<li>send_message_chat_room error: <pre>${error}</pre></li>`);
                $('#debug_list').animate({scrollTop: $('#debug_list').prop("scrollHeight")}, 123);
            } else {
                $("#debug_list").append(`<li>call_answer: <pre>${JSON.stringify(message, null, 4)}</pre></li>`);
                $('#debug_list').animate({scrollTop: $('#debug_list').prop("scrollHeight")}, 123);
            }
        });
    });

    $('#call_close').click(function () {
        socket.emit(SOCKET_KEY_CALL_CLOSE,{
            channel: $('#channel_id').val(),
            type: channel_type,
        },function (error, message) {
            if (error) {
                console.error(error);
                $("#debug_list").append(`<li>send_message_chat_room error: <pre>${error}</pre></li>`);
                $('#debug_list').animate({scrollTop: $('#debug_list').prop("scrollHeight")}, 123);
            } else {
                $("#debug_list").append(`<li>call_close: <pre>${JSON.stringify(message, null, 4)}</pre></li>`);
                $('#debug_list').animate({scrollTop: $('#debug_list').prop("scrollHeight")}, 123);
            }
        });
    });

    $('.send_file_button').click(function () {
        const type = $(this).attr('data-type');
        content_type = parseInt(type);
    });

    $("#send_file_button").click(function () {

        if (socket == null) {
            return alert("Please connect to socket server first")
        }

        if ($('#selected_file').get(0).files.length === 0) {
            return alert("No files selected.")
        }

        $("#upload_content").hide();
        $("#upload_loading").show();

        var uploadEndPoint = $("#server_url").val()+'/v1.0/upload';

        var formData = new FormData();
        formData.append('file', $('#selected_file')[0].files[0]);
        formData.append("user_type", $("#user_type").val());
        formData.append("user_id", $("#user_id").val());
        formData.append("channel_id", $("#channel_id").val());
        formData.append("file_type", content_type);

        $.ajax({
            url : uploadEndPoint,
            type : 'POST',
            mimeType: "multipart/form-data",
            beforeSend: function(request) {
                request.setRequestHeader("Authorization", $("#token").val());
            },
            contentType: false,
            data : formData,
            processData: false,
            success : function(data) {

                $('#send_file_model').modal('hide');
                $("#upload_content").show();
                $("#upload_loading").hide();

                socket.emit(SOCKET_KEY_CHAT_MESSAGE,{
                    to: $('#channel_id').val(),
                    content: {
                        image: content_type == ChatContentType.Image? data: null,
                        video: content_type == ChatContentType.Video? data: null,
                        audio: content_type == ChatContentType.Audio? data: null,
                        type: content_type,
                    },
                    type: channel_type,
                },function (response) {
                    content_type = ChatContentType.Text;
                    $("#debug_list").append(`<li>send_message_chat_room: <pre>${JSON.stringify(JSON.parse(response), null, 4)}</pre></li>`);
                    $('#debug_list').animate({scrollTop: $('#debug_list').prop("scrollHeight")}, 123);
                });

                var jsonData = JSON.parse(data);
                $("#debug_list").append(`<li>upload_file_response: <pre>${JSON.stringify(jsonData, null, 4)}</pre></li>`);
                $('#debug_list').animate({scrollTop: $('#debug_list').prop("scrollHeight")}, 123);

                content_type = ChatContentType.Text;
            },
            error: function (error) {

                $("#upload_content").show();
                $("#upload_loading").hide();

                $("#debug_list").append(`<li>upload_file_response: <pre>${JSON.stringify(error, null, 4)}</pre></li>`);
                $('#debug_list').animate({scrollTop: $('#debug_list').prop("scrollHeight")}, 123);
            }
        });

    });

    $("#disconnect_from_socket").click(function () {
        socket.close();
    });

    function sendSystemMessage(orderId,message) {
        var systemMessageEndpoint = $("#server_url").val()+'/v1.0/chat/system/message';
        $.ajax({
            url : systemMessageEndpoint,
            type : 'POST',
            beforeSend: function(request) {
                request.setRequestHeader("Authorization", $("#token").val());
            },
            dataType: 'json',
            contentType: 'application/json',
            data : JSON.stringify({
                "channel_id": orderId,
                "content_type": "text",
                "message_content": message
            }),
            processData: false,
            success : function(data) {
                $("#debug_list").append(`<li>system_message: <pre>${JSON.stringify(data, null, 4)}</pre></li>`);
                $('#debug_list').animate({scrollTop: $('#debug_list').prop("scrollHeight")}, 123);
            },
            error: function (error) {
                $("#debug_list").append(`<li>system_message: <pre>${JSON.stringify(error, null, 4)}</pre></li>`);
                $('#debug_list').animate({scrollTop: $('#debug_list').prop("scrollHeight")}, 123);
            }
        });
    }
</script>
</body>
</html>